<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Regular Joe</title>
<style>
:root{--bg:#0b0d10;--card:#131722;--text:#e7eaf0;--mut:#9aa5b5;--line:#243044;--acc:#4da3ff}
@media (prefers-color-scheme: light){:root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--mut:#5b6576;--line:#e6e8ef;--acc:#0b6bff}}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:920px;margin:0 auto}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0)),var(--bg);backdrop-filter:blur(8px)}
.top{display:flex;gap:.6rem;align-items:center;justify-content:space-between;padding:.75rem .75rem .5rem}
h1{font-size:1.05rem;margin:0}
.small{font-size:.85rem;color:var(--mut)}
.controls{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;padding:0 .75rem .75rem}
@media(min-width:760px){.controls{grid-template-columns:2fr 1fr 1fr}}
input,select,textarea{width:100%;padding:.65rem .7rem;border-radius:.75rem;border:1px solid var(--line);background:transparent;color:var(--text);font-size:1rem}
textarea{min-height:6rem;resize:vertical}
.btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);padding:.55rem .7rem;border-radius:.75rem;font-weight:800}
.btn.primary{background:var(--acc);border-color:transparent;color:#fff}
.grid{padding:.5rem .75rem 1.2rem;display:grid;grid-template-columns:1fr;gap:.6rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:1rem;padding:.75rem}
.row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
.badge{font-size:.75rem;font-weight:900;padding:.2rem .55rem;border-radius:999px;border:1px solid var(--line)}
.badge.Applied{border-color:rgba(77,163,255,.4)} .badge.Interview{border-color:rgba(255,159,67,.5)}
.badge.Offer{border-color:rgba(40,199,111,.5)} .badge.Rejected,.badge.Withdrawn{border-color:rgba(234,84,85,.5)}
.badge.Ghosted{border-color:rgba(153,163,179,.5)}
a{color:var(--acc);text-decoration:none}
dialog{border:none;border-radius:1rem;width:min(720px,95vw);background:var(--card);color:var(--text);border:1px solid var(--line)}
dialog::backdrop{background:rgba(0,0,0,.6)}
.actions{display:flex;gap:.5rem;justify-content:flex-end;flex-wrap:wrap}
hr{border:none;border-top:1px solid var(--line);margin:.6rem 0}
</style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüê∂%3C/text%3E%3C/svg%3E"><text y=%22.9em%22 font-size=%2290%22>üê∂</text></svg>"></head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Regular Joe</h1>
        <div class="small"><a href="https://gobackumbrae.github.io/regularjoe.job/" target="_blank" rel="noopener">regularjoe.job</a> ¬∑ <span id="stats">Loading‚Ä¶</span></div>
      </div>
      <div class="row">
        <button class="btn" id="importBtn">Import</button>
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn primary" id="addBtn">+ Add</button>
      </div>
    </div>
    <div class="controls">
      <input id="q" placeholder="Search company, title, notes‚Ä¶" autocomplete="off">
      <select id="status">
        <option value="">All statuses</option>
        <option>Saved</option><option>Applied</option><option>Interview</option>
        <option>Offer</option><option>Rejected</option><option>Ghosted</option><option>Withdrawn</option>
      </select>
      <select id="sort">
        <option value="updatedDesc">Recently updated</option>
        <option value="appliedDesc">Applied (new‚Üíold)</option>
        <option value="companyAsc">Company (A‚ÜíZ)</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid" id="list"></div>
</main>

<input id="file" type="file" accept=".csv,.xlsx,.xls" hidden>

<dialog id="dlg">
  <form method="dialog" class="card" id="form" style="margin:0">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:950">Application</div>
      <button class="btn" value="cancel">‚úï</button>
    </div>
    <hr>
    <div class="row"><div style="flex:1"><div class="small">Company</div><input id="company" required autocomplete="organization"></div></div>
    <div class="row"><div style="flex:1"><div class="small">Job title</div><input id="title" required autocomplete="off"></div></div>
    <div class="row">
      <div style="flex:1"><div class="small">Status</div>
        <select id="fstatus">
          <option>Saved</option><option>Applied</option><option>Interview</option>
          <option>Offer</option><option>Rejected</option><option>Ghosted</option><option>Withdrawn</option>
        </select>
      </div>
      <div style="flex:1"><div class="small">Applied</div><input id="applied" type="date" autocomplete="off"></div>
    </div>
    <div class="row">
      <div style="flex:1"><div class="small">Follow‚Äëup</div><input id="follow" type="date" autocomplete="off"></div>
      <div style="flex:1"><div class="small">Location</div><input id="location" placeholder="e.g. Sydney (Hybrid)" autocomplete="off"></div>
    </div>
    <div class="row"><div style="flex:1"><div class="small">Job URL</div><input id="url" placeholder="https://‚Ä¶" autocomplete="url"></div></div>
    <div class="row"><div style="flex:1"><div class="small">Notes</div><textarea id="notes" autocomplete="off"></textarea></div></div>
    <div class="actions">
      <button type="button" class="btn" id="delBtn" style="margin-right:auto;display:none">Delete</button>
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn primary" id="saveBtn" value="default">Save</button>
    </div>
  </form>
</dialog>

<script>
(() => {
  const KEY="jobTracker.v1";
  const $=id=>document.getElementById(id);
  const els={list:$("list"),stats:$("stats"),q:$("q"),status:$("status"),sort:$("sort"),
             addBtn:$("addBtn"),exportBtn:$("exportBtn"),importBtn:$("importBtn"),file:$("file"),
             dlg:$("dlg"),form:$("form"),delBtn:$("delBtn"),
             company:$("company"),title:$("title"),fstatus:$("fstatus"),applied:$("applied"),follow:$("follow"),
             location:$("location"),url:$("url"),notes:$("notes")};

  let apps=load(), editing=null;

  function load(){try{return JSON.parse(localStorage.getItem(KEY)||"[]")}catch{return []}}
  function save(){localStorage.setItem(KEY,JSON.stringify(apps))}
  function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
  function esc(s){return (s||"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]))}
  function badge(st){return `<span class="badge ${esc(st)}">${esc(st)}</span>`}

  function stats(){
    const by={}; for(const a of apps){by[a.status]=(by[a.status]||0)+1}
    const parts=["Total:"+apps.length].concat(Object.keys(by).sort().map(k=>k+":"+by[k]));
    els.stats.textContent=parts.join(" ¬∑ ");
  }

  function filtered(){
    const q=(els.q.value||"").toLowerCase().trim();
    const st=els.status.value;
    let out=apps.slice();
    if(st) out=out.filter(a=>a.status===st);
    if(q) out=out.filter(a=>[a.company,a.title,a.location,a.url,a.notes].join(" ").toLowerCase().includes(q));
    const s=els.sort.value;
    if(s==="companyAsc") out.sort((a,b)=>(a.company||"").localeCompare(b.company||""));
    else if(s==="appliedDesc") out.sort((a,b)=>(b.applied||"").localeCompare(a.applied||""));
    else out.sort((a,b)=>(b.updated||0)-(a.updated||0));
    return out;
  }

  function render(){
    stats();
    const items=filtered();
    if(!items.length){
      els.list.innerHTML=`<div class="card"><b>No matches</b><div class="small">Tap ‚Äú+ Add‚Äù to create one.</div></div>`;
      return;
    }
    els.list.innerHTML = items.map(a=>{
      const meta=[
        a.applied?`Applied: <b>${esc(a.applied)}</b>`:"",
        a.follow?`Follow‚Äëup: <b>${esc(a.follow)}</b>`:"",
        a.location?`Loc: <b>${esc(a.location)}</b>`:""
      ].filter(Boolean).join(" ¬∑ ");
      const link=a.url?`<a href="${esc(a.url)}" target="_blank" rel="noopener">Open link</a>`:"";
      return `<div class="card" data-id="${esc(a.id)}">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div style="min-width:0">
            <div style="font-weight:950">${esc(a.company)}</div>
            <div style="font-weight:750">${esc(a.title)}</div>
            <div class="small" style="margin-top:.25rem">${meta||"&nbsp;"}</div>
          </div>
          ${badge(a.status)}
        </div>
        <div class="row" style="margin-top:.6rem;justify-content:space-between">
          <div class="small">${link}</div>
          <div class="small">Updated: ${new Date(a.updated||0).toISOString().slice(0,10)}</div>
        </div>
      </div>`;
    }).join("");
    els.list.querySelectorAll(".card[data-id]").forEach(c=>{
      c.addEventListener("click",()=>openEdit(c.getAttribute("data-id")));
    });
  }

  function openNew(){
    editing=null;
    els.delBtn.style.display="none";
    els.company.value=""; els.title.value="";
    els.fstatus.value="Saved";
    els.applied.value=new Date().toISOString().slice(0,10);
    els.follow.value=""; els.location.value=""; els.url.value=""; els.notes.value="";
    els.dlg.showModal(); setTimeout(()=>els.company.focus(),30);
  }

  function openEdit(id){
    const a=apps.find(x=>String(x.id)===String(id)); if(!a) return;
    editing=a.id;
    els.delBtn.style.display="";
    els.company.value=a.company||""; els.title.value=a.title||"";
    els.fstatus.value=a.status||"Saved";
    els.applied.value=a.applied||""; els.follow.value=a.follow||"";
    els.location.value=a.location||""; els.url.value=a.url||""; els.notes.value=a.notes||"";
    els.dlg.showModal();
  }

  function upsert(){
    const a={
      id: editing||uid(),
      company: els.company.value.trim(),
      title: els.title.value.trim(),
      status: els.fstatus.value,
      applied: els.applied.value,
      follow: els.follow.value,
      location: els.location.value.trim(),
      url: els.url.value.trim(),
      notes: els.notes.value.trim(),
      updated: Date.now()
    };
    if(!a.company||!a.title) return;
    const i=apps.findIndex(x=>String(x.id)===String(a.id));
    if(i>=0) apps[i]=a; else apps.unshift(a);
    save(); render();
  }

  function del(){
    if(!editing) return;
    if(!confirm("Delete this application?")) return;
    apps=apps.filter(x=>String(x.id)!==String(editing));
    save(); render(); els.dlg.close();
  }

  function exportJson(){
    const blob=new Blob([JSON.stringify({apps,exportedAt:new Date().toISOString()},null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="job-tracker-backup.json";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1500);
  }

  function importJson(file){
    const r=new FileReader();
    r.onload=()=>{
      try{
        const obj=JSON.parse(r.result);
        const incoming=Array.isArray(obj)?obj:(obj.apps||[]);
        if(!Array.isArray(incoming)) throw new Error("Bad format");
        const map=new Map(apps.map(a=>[String(a.id),a]));
        for(const x of incoming){
          if(!x) continue;
          const id=String(x.id||uid());
          map.set(id,{
            id,
            company:String(x.company||"").trim(),
            title:String(x.title||"").trim(),
            status:String(x.status||"Saved"),
            applied:String(x.applied||""),
            follow:String(x.follow||""),
            location:String(x.location||"").trim(),
            url:String(x.url||"").trim(),
            notes:String(x.notes||"").trim(),
            updated:Number(x.updated||Date.now())
          });
        }
        apps=[...map.values()].filter(a=>a.company&&a.title);
        save(); render();
        alert("Imported "+incoming.length+" records.");
      }catch(e){ alert("Import failed: "+e.message); }
    };
    r.readAsText(file);
  }

  els.addBtn.onclick=openNew;
  els.delBtn.onclick=del;
  els.form.addEventListener("submit",(e)=>{e.preventDefault(); upsert(); els.dlg.close();});
  els.q.oninput=render; els.status.onchange=render; els.sort.onchange=render;

  els.exportBtn.onclick=exportJson;
  els.importBtn.onclick=()=>els.file.click();
  els.file.onchange=(e)=>{const f=e.target.files&&e.target.files[0]; if(f) importFile(f); els.file.value="";};

  render();

/*JT_PATCH_V1: CSV/XLSX import + CSV export + fix importFile */
function __jt_iso(v){
  if(!v) return "";
  if(v instanceof Date) return v.toISOString().slice(0,10);
  if(typeof v==="number" && isFinite(v)){
    const d=new Date(Math.round((v-25569)*86400*1000));
    return isNaN(d)?"":d.toISOString().slice(0,10);
  }
  const s=String(v).trim();
  return /^\d{4}-\d{2}-\d{2}$/.test(s)?s:"";
}
function __jt_get(row, ...names){
  const m={};
  for(const k in (row||{})){
    m[String(k).toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")] = row[k];
  }
  for(const n of names){
    const v=m[n];
    if(v!=null && String(v).trim()!=="") return v;
  }
  return "";
}
function __jt_mergeRows(rows){
  const recs=[];
  for(const r of rows||[]){
    const company=String(__jt_get(r,"company","company_name","company_names","employer","organisation","organization")).trim();
    const title  =String(__jt_get(r,"job_title","job_title_norm","title","role","position")).trim();
    if(!company || !title) continue;

    const applied = __jt_iso(__jt_get(r,"applied","applied_date","date_applied","application_date","submitted_date","date"));
    recs.push({
      id: String(__jt_get(r,"id","app_row","application_id") || Date.now()+Math.random()),
      company, title,
      status: String(__jt_get(r,"status","application_status") || (applied?"Applied":"Saved")),
      applied,
      follow: __jt_iso(__jt_get(r,"follow","follow_up","followup","next_follow_up","next_followup")),
      location: String(__jt_get(r,"location","city","region")).trim(),
      url: String(__jt_get(r,"url","job_url","link","job_link","posting_url")).trim(),
      resume: String(__jt_get(r,"resume","resume_id","resume_project_id","resume_project_name","resume_version")).trim(),
      cover: String(__jt_get(r,"cover","cover_id","cover_project_id","cover_project_name","cover_version")).trim(),
      notes: String(__jt_get(r,"notes","note","comments","comment")).trim(),
      updated: Date.now(),
    });
  }

  // merge: just prepend imported records
  apps = recs.concat(apps);

  try{ save(apps); }catch(e){ try{ save(); }catch(_){} }
  try{ render(); }catch(e){}

  alert("Imported " + recs.length + " rows");
}
function __jt_importAny(file){
  if(!window.XLSX){ alert("XLSX parser not loaded. Reload the page."); return; }
  const name=(file.name||"").toLowerCase();
  const fr=new FileReader();
  fr.onload=()=>{
    try{
      const wb = name.endsWith(".csv")
        ? XLSX.read(String(fr.result), {type:"string"})
        : XLSX.read(new Uint8Array(fr.result), {type:"array", cellDates:true});

      const sn = (wb.SheetNames||[]).find(n=>String(n).toLowerCase()==="applications_clean") || (wb.SheetNames||[])[0];
      const ws = wb.Sheets[sn];
      const rows = XLSX.utils.sheet_to_json(ws, {defval:""});
      __jt_mergeRows(rows);
    }catch(e){
      alert("Import failed: " + e.message);
    }
  };
  if(name.endsWith(".csv")) fr.readAsText(file);
  else fr.readAsArrayBuffer(file);
}

// fix your current crash + keep old handler name working
function importFile(file){ __jt_importAny(file); }
function importJsonFile(file){ __jt_importAny(file); }

// override Export so it exports CSV (human-readable)
function exportJson(){
  if(!window.XLSX){ alert("XLSX parser not loaded. Reload the page."); return; }
  const cols=["company","title","status","applied","follow","location","url","resume","cover","notes"];
  const rows=apps.map(a=>{const o={}; for(const c of cols) o[c]=a[c]||""; return o;});
  const ws=XLSX.utils.json_to_sheet(rows,{header:cols,skipHeader:false});
  const csv=XLSX.utils.sheet_to_csv(ws);

  const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.download=`job-tracker-${y}${m}${da}.csv`;
  a.href=URL.createObjectURL(blob);
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),2000);
}

})();
</script>
</body>
</html>
